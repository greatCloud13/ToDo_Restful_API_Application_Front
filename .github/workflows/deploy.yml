name: React Frontend CI/CD

# íŠ¸ë¦¬ê±°: main ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci
      
      # 4. í”„ë¡œë•ì…˜ ë¹Œë“œ
      - name: Build React App
        run: npm run build
        env:
          REACT_APP_API_BASE_URL: http://13.124.204.209
          CI: false  # ê²½ê³ ë¥¼ ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
      
      # 5. ë¹Œë“œ íŒŒì¼ì„ EC2ë¡œ ì „ì†¡
      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/*"
          target: "~/react-build-temp"
          strip_components: 1
      
      # 6. EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Execute deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ë°±ì—…
            if [ -d ~/react-build ]; then
              mv ~/react-build ~/react-build-backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            # ìƒˆ ë¹Œë“œ íŒŒì¼ ì´ë™
            mv ~/react-build-temp ~/react-build
            
            # Nginx ì¬ì‹œì‘ (Docker Compose)
            cd ~
            sudo docker compose restart nginx
            
            # ë°°í¬ í™•ì¸
            sleep 5
            curl -f http://localhost || echo "Health check failed"
            
            # ì„±ê³µ ì‹œ ë°±ì—… íŒŒì¼ ì •ë¦¬ (ìµœê·¼ 3ê°œë§Œ ìœ ì§€)
            ls -dt ~/react-build-backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            
            echo "Frontend deployment completed successfully!"
      
      # 7. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Deployment Summary
        run: |
          echo "ğŸš€ Frontend Deployment Complete!"
          echo "ğŸ“¦ Build size: $(du -sh build | cut -f1)"
          echo "ğŸŒ URL: http://13.124.204.209"
          echo "â° Deployed at: $(date)"